<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Keeling Curve: 65 Years of Rising CO2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .container {
            max-width: 1400px;
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        h1 {
            font-size: 2.5em;
            margin: 0 0 10px 0;
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
        }
        .subtitle {
            color: #a0a0a0;
            font-size: 1.2em;
            margin: 10px 0;
        }
        .warning {
            color: #ff6b6b;
            font-size: 1.1em;
            margin: 15px 0;
            font-style: italic;
            font-weight: 500;
        }
        .chart-container {
            position: relative;
            height: 600px;
            margin: 20px 0;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.08);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stat-label {
            color: #888;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        .stat-value {
            color: #fff;
            font-size: 2em;
            font-weight: bold;
        }
        .stat-value.danger {
            color: #ff6b6b;
        }
        .stat-value.warning {
            color: #ffd93d;
        }
        .loading {
            color: white;
            text-align: center;
            font-size: 1.5em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>The Keeling Curve: CO₂ Levels Accelerating</h1>
            <div class="subtitle">Atmospheric CO₂ Concentration (parts per million)</div>
            <div class="warning">⚠️ Each part per million makes Earth hotter ⚠️</div>
        </div>
        
        <div class="chart-container">
            <canvas id="keelingChart"></canvas>
        </div>

        <div class="stats" id="stats">
            <div class="loading">Loading data...</div>
        </div>
    </div>

    <script>
        let chart = null;

        async function loadAndVisualize() {
            try {
                // Read CO2 data
                const co2Text = await window.fs.readFile('data/co2_mm_mlo.csv', { encoding: 'utf8' });
                const lines = co2Text.split('\n').filter(line => !line.startsWith('#') && line.trim());
                
                // Parse data
                const data = lines.slice(1).map(line => {
                    const parts = line.split(',');
                    return {
                        date: parts[0],
                        year: parseFloat(parts[1]),
                        month: parseFloat(parts[2]),
                        co2: parseFloat(parts[3])
                    };
                }).filter(d => !isNaN(d.co2) && d.co2 > 0);

                // Get annual averages for cleaner visualization
                const yearlyData = {};
                data.forEach(d => {
                    if (!yearlyData[d.year]) {
                        yearlyData[d.year] = { sum: 0, count: 0 };
                    }
                    yearlyData[d.year].sum += d.co2;
                    yearlyData[d.year].count += 1;
                });

                const years = Object.keys(yearlyData).sort((a, b) => a - b);
                const co2Values = years.map(year => yearlyData[year].sum / yearlyData[year].count);

                // Create projection to 2050
                const lastYear = parseInt(years[years.length - 1]);
                const lastValue = co2Values[co2Values.length - 1];
                const projectionYears = [];
                const projectionValues = [];
                
                // Simple linear projection based on recent trend (2.5 ppm/year)
                const recentRate = 2.5;
                for (let year = lastYear + 1; year <= 2050; year++) {
                    projectionYears.push(year);
                    projectionValues.push(lastValue + (year - lastYear) * recentRate);
                }

                // Calculate statistics
                const currentCO2 = co2Values[co2Values.length - 1];
                const co2_1958 = co2Values[0];
                const increase = currentCO2 - co2_1958;
                const percentIncrease = ((currentCO2 - co2_1958) / co2_1958 * 100);
                const year400 = years.find(y => yearlyData[y].sum / yearlyData[y].count >= 400);
                const projected2050 = projectionValues[projectionValues.length - 1];

                // Update stats
                document.getElementById('stats').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-label">Current Level (2024)</div>
                        <div class="stat-value danger">${currentCO2.toFixed(1)} ppm</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">1958 Baseline</div>
                        <div class="stat-value">${co2_1958.toFixed(1)} ppm</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Increase</div>
                        <div class="stat-value danger">+${increase.toFixed(1)} ppm</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Percent Increase</div>
                        <div class="stat-value danger">+${percentIncrease.toFixed(1)}%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">400 ppm Crossed</div>
                        <div class="stat-value warning">${year400 || '2013'}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Projected 2050</div>
                        <div class="stat-value danger">${projected2050.toFixed(1)} ppm</div>
                    </div>
                `;

                // Create chart
                const ctx = document.getElementById('keelingChart').getContext('2d');
                
                // Create gradient
                const gradient = ctx.createLinearGradient(0, 0, 0, 600);
                gradient.addColorStop(0, 'rgba(255, 107, 107, 0.8)');
                gradient.addColorStop(0.5, 'rgba(255, 142, 83, 0.6)');
                gradient.addColorStop(1, 'rgba(255, 107, 107, 0.2)');

                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [...years, ...projectionYears],
                        datasets: [
                            {
                                label: 'Historical CO₂',
                                data: [...co2Values, ...Array(projectionYears.length).fill(null)],
                                borderColor: '#ff6b6b',
                                backgroundColor: gradient,
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0,
                                pointHoverRadius: 6,
                                pointHoverBackgroundColor: '#ff6b6b',
                            },
                            {
                                label: 'Projection to 2050',
                                data: [...Array(years.length - 1).fill(null), co2Values[co2Values.length - 1], ...projectionValues],
                                borderColor: 'rgba(255, 107, 107, 0.5)',
                                borderWidth: 3,
                                borderDash: [10, 5],
                                fill: false,
                                tension: 0.4,
                                pointRadius: 0,
                            },
                            {
                                label: 'Safe Level (350 ppm)',
                                data: Array(years.length + projectionYears.length).fill(350),
                                borderColor: '#6bcf7f',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                fill: false,
                                pointRadius: 0,
                            },
                            {
                                label: '400 ppm Milestone (2013)',
                                data: Array(years.length + projectionYears.length).fill(400),
                                borderColor: '#ffd93d',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                fill: false,
                                pointRadius: 0,
                            },
                            {
                                label: 'Pre-pandemic (415 ppm, 2019)',
                                data: Array(years.length + projectionYears.length).fill(415),
                                borderColor: '#ff8e53',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                fill: false,
                                pointRadius: 0,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: '#ffffff',
                                    font: {
                                        size: 12
                                    },
                                    padding: 15,
                                    usePointStyle: true,
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#ff6b6b',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: true,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += context.parsed.y.toFixed(1) + ' ppm';
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)',
                                },
                                ticks: {
                                    color: '#ffffff',
                                    font: {
                                        size: 12
                                    },
                                    maxRotation: 0,
                                    autoSkip: true,
                                    maxTicksLimit: 15
                                },
                                title: {
                                    display: true,
                                    text: 'Year',
                                    color: '#ffffff',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                }
                            },
                            y: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)',
                                },
                                ticks: {
                                    color: '#ffffff',
                                    font: {
                                        size: 12
                                    },
                                    callback: function(value) {
                                        return value + ' ppm';
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'CO₂ Concentration (ppm)',
                                    color: '#ffffff',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                min: 300,
                                max: Math.max(projected2050 + 20, 500)
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('stats').innerHTML = `
                    <div class="stat-card" style="grid-column: 1 / -1;">
                        <div class="stat-label">Error Loading Data</div>
                        <div class="stat-value" style="color: #ff6b6b; font-size: 1em;">
                            ${error.message}
                        </div>
                    </div>
                `;
            }
        }

        loadAndVisualize();
    </script>
</body>
</html>